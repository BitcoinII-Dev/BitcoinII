name: macOS arm64 .dmg (v0.27.1, full features)

on:
  workflow_dispatch:

jobs:
  build-dmg-v27:
    runs-on: macos-14  # Apple Silicon runner

    env:
      TARGET_TAG: v0.27.1

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout release tag
        run: |
          git fetch --tags
          git checkout "$TARGET_TAG"
          git submodule update --init --recursive || true

      - name: Show environment info
        run: |
          uname -a
          sw_vers
          sysctl -n hw.logicalcpu || true

      - name: Install build dependencies (Homebrew)
        run: |
          brew update

          brew install \
            automake \
            libtool \
            pkg-config \
            boost \
            libevent \
            libnatpmp \
            qrencode \
            sqlite \
            zeromq \
            berkeley-db@4 \
            qt@5

          # Make Qt5 tools visible
          echo "$(brew --prefix qt@5)/bin" >> "$GITHUB_PATH"

      - name: Configure BitcoinII-Core (v0.27.1, BDB + extras)
        run: |
          ./autogen.sh

          
          export BDB_PREFIX="$(brew --prefix berkeley-db@4)"
          export CPPFLAGS="-I$(brew --prefix zeromq)/include ${CPPFLAGS:-}"
          export LDFLAGS="-L$(brew --prefix zeromq)/lib ${LDFLAGS:-}"

          
          EXTRA_CONF_FLAGS=""
          

          ./configure \
            --with-gui=qt5 \
            --enable-zmq \
            --enable-natpmp \
            --enable-reduce-exports \
            --with-boost="$(brew --prefix boost)" \
            BDB_LIBS="-L${BDB_PREFIX}/lib -ldb_cxx-4.8" \
            BDB_CFLAGS="-I${BDB_PREFIX}/include" \
            ${EXTRA_CONF_FLAGS}

      - name: Build (make)
        run: |
          CORES="$(sysctl -n hw.logicalcpu || echo 4)"
          echo "Building with $CORES cores"
          make -j"$CORES"

      - name: Build .dmg (make deploy)
        run: |
          make deploy

          echo "DMG files in repo root:"
          ls -1 *.dmg || true

          echo "DMG files under src/qt:"
          ls -1 src/qt/*.dmg || true

      - name: Upload .dmg artifacts
        uses: actions/upload-artifact@v4
        with:
          name: bitcoinII-core-v0.27.1-macos-arm64-dmg
          path: |
            *.dmg
            src/qt/*.dmg
          if-no-files-found: error
